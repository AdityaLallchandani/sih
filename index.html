<!DOCTYPE html>
<html lang="en" id="html-root">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title data-translate="title">AgroSmart AI Dashboard</title>
    <style>
      :root {
        --primary-green: #22c55e;
        --dark-text: #1f2937;
        --body-text: #4b5563;
        --background-light: #f9fafb;
        --white: #ffffff;
        --border-color: #e5e7eb;
        --alert-red: #ef4444;
        --alert-info: #3b82f6;
        --blue: #3b82f6;
        --orange: #f97316;
        --purple: #8b5cf6;
        --chip-bg: #f1f5f9;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background: var(--background-light);
        color: var(--body-text);
        line-height: 1.45;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 18px;
      }

      /* Header */
      .dashboard-header {
        background: var(--white);
        border-bottom: 1px solid var(--border-color);
      }
      .dashboard-header .inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 14px 0;
      }
      .logo {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--dark-text);
        text-decoration: none;
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .small {
        font-size: 0.88rem;
      }
      .muted {
        color: var(--body-text);
        opacity: 0.95;
      }

      select,
      button,
      input[type="file"],
      input[type="text"] {
        font: inherit;
      }

      .btn {
        cursor: pointer;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 10px;
        background: var(--white);
        color: var(--dark-text);
      }
      .btn.primary {
        background: var(--primary-green);
        color: white;
        border: none;
      }
      .btn.blue {
        background: var(--blue);
        color: white;
        border: none;
      }
      .btn.orange {
        background: var(--orange);
        color: white;
        border: none;
      }
      .btn.purple {
        background: var(--purple);
        color: white;
        border: none;
      }

      /* Language selector styling */
      .language-selector {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      #language-selector {
        min-width: 90px;
        font-size: 0.88rem;
      }

      /* Layout */
      .grid {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 20px;
        margin-top: 18px;
      }
      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--white);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .card h3,
      .card h4 {
        margin: 0;
        color: var(--dark-text);
      }
      .metric {
        display: flex;
        align-items: baseline;
        gap: 10px;
      }
      .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark-text);
      }
      .sub {
        font-size: 0.95rem;
        color: var(--body-text);
      }

      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .spaced {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        width: 100%;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--chip-bg);
        border: 1px solid var(--border-color);
        font-size: 0.9rem;
        color: var(--dark-text);
      }
      .chip.success {
        background: #ecfdf5;
        color: #065f46;
        border-color: #a7f3d0;
      }
      .chip.warn {
        background: #fff7ed;
        color: #7c2d12;
        border-color: #fed7aa;
      }
      .chip.danger {
        background: #fef2f2;
        color: #7f1d1d;
        border-color: #fecaca;
      }

      .badge {
        display: inline-block;
        border-radius: 8px;
        padding: 4px 8px;
        font-size: 0.78rem;
        border: 1px solid var(--border-color);
        background: var(--chip-bg);
      }
      .badge.high {
        background: #fef2f2;
        color: #991b1b;
        border-color: #fecaca;
      }
      .badge.medium {
        background: #fff7ed;
        color: #9a3412;
        border-color: #fed7aa;
      }
      .badge.low {
        background: #ecfdf5;
        color: #065f46;
        border-color: #a7f3d0;
      }

      /* Gemini widget */
      .gemini-widget .output {
        background: #f8fafc;
        border: 1px dashed var(--border-color);
        border-radius: 10px;
        padding: 12px;
        min-height: 120px;
        white-space: pre-wrap;
        font-family: inherit;
        line-height: 1.4;
      }

      /* Analysis result styling */
      .analysis-result {
        border-left: 4px solid;
        padding-left: 12px;
        margin: 8px 0;
      }
      .analysis-result.healthy {
        border-left-color: var(--primary-green);
      }
      .analysis-result.warning {
        border-left-color: var(--orange);
      }
      .analysis-result.critical {
        border-left-color: var(--alert-red);
      }
      .confidence-bar {
        background: #e5e7eb;
        height: 4px;
        border-radius: 2px;
        margin: 4px 0;
        overflow: hidden;
      }
      .confidence-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s ease;
      }
      .confidence-fill.high {
        background: var(--primary-green);
      }
      .confidence-fill.medium {
        background: var(--orange);
      }
      .confidence-fill.low {
        background: var(--alert-red);
      }

      .image-upload label {
        display: block;
        font-weight: 500;
        margin-bottom: 6px;
      }
      #gemini-image-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
      }
      #gemini-image-preview {
        display: none;
        max-height: 140px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }

      .chat {
        margin-top: 10px;
        border-top: 1px solid var(--border-color);
        padding-top: 12px;
      }
      .chat-window {
        height: 260px;
        overflow: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        background: #f8fafc;
      }
      .chat-msg {
        margin-bottom: 10px;
      }
      .chat-msg .role {
        font-weight: 700;
        color: var(--dark-text);
        margin-right: 6px;
      }
      .chat-input-row {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        align-items: center;
      }
      #chat-input {
        flex: 1;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px;
        background: var(--white);
        color: var(--dark-text);
      }

      .list {
        display: grid;
        gap: 10px;
        margin-top: 8px;
      }
      .list-item {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        background: #f8fafc;
        display: block;
      }
      .list-item .title {
        font-weight: 700;
        color: var(--dark-text);
      }

      .alerts-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .alert {
        padding: 12px;
        border-radius: 8px;
        border: 1px solid;
        border-left-width: 4px;
      }
      .alert.alert-critical {
        background: #fef2f2;
        border-color: #fecaca;
        border-left-color: var(--alert-red);
        color: #991b1b;
      }
      .alert.alert-info {
        background: #eff6ff;
        border-color: #bfdbfe;
        border-left-color: var(--alert-info);
        color: #1e40af;
      }

      .forecast-container {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
      }
      .forecast-day {
        padding: 10px;
        text-align: center;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: #f8fafc;
      }
      @media (max-width: 600px) {
        .forecast-container {
          grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        }
      }
    </style>
  </head>

  <body>
    <!-- HEADER -->
    <header class="dashboard-header">
      <div class="container inner">
        <a class="logo" href="#" data-translate="logo">AgroSmart AI</a>
        <div class="header-actions">
          <div class="language-selector">
            <label
              for="language-selector"
              class="small"
              data-translate="language"
              >Language:</label
            >
            <select id="language-selector" class="btn">
              <option value="en">English</option>
              <option value="hi">हिंदी</option>
              <option value="gu">ગુજરાતી</option>
              <option value="mr">मराठी</option>
            </select>
          </div>
          <label for="farm-selector" class="small" data-translate="farm"
            >Farm:</label
          >
          <select id="farm-selector" class="btn">
            <option data-translate="field_a_wheat">Field A — Wheat</option>
            <option data-translate="field_b_maize">Field B — Maize</option>
          </select>
          <div
            id="last-updated"
            class="small muted"
            data-translate="last_updated"
          >
            Last Updated: —
          </div>
          <a class="btn" href="#" data-translate="logout">Logout</a>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="container">
      <div class="grid">
        <!-- LEFT COLUMN -->
        <div style="display: flex; flex-direction: column; gap: 20px">
          <!-- Sensor Metrics -->
          <div class="card">
            <div class="row">
              <div>
                <h4 data-translate="soil_moisture">Soil Moisture</h4>
                <div class="metric">
                  <div id="soilMoistureValue" class="value">45%</div>
                  <div class="chip success">
                    <span data-translate="optimal">Optimal</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div>
                <h4 data-translate="soil_temperature">Soil Temperature</h4>
                <div id="soilTemperatureValue" class="value">22°C</div>
              </div>
            </div>

            <div class="row">
              <div>
                <h4 data-translate="atmosphere">Atmosphere</h4>
                <div class="metric">
                  <div id="atmosphereValue" class="value">--°C / --%</div>
                  <div class="sub" data-translate="temp_humidity">
                    Temp / Humidity
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div>
                <h4 data-translate="water_level">Water Level</h4>
                <div class="metric">
                  <div id="waterLevelValue" class="value">-- cm</div>
                  <div class="sub" data-translate="distance_from_sensor">
                    Distance from Sensor
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div>
                <h4 data-translate="wind">Wind</h4>
                <div class="metric">
                  <div id="windValue" class="value">12 km/h</div>
                  <div class="sub" data-translate="from_nw">from NW</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Irrigation -->
          <div class="card">
            <h3 data-translate="irrigation_control">Irrigation Control</h3>
            <div class="spaced">
              <div>
                <div id="irrigationStatus" data-translate="last_watered">
                  Last Watered: Today at 6:00 AM
                </div>
              </div>
              <button class="btn primary" onclick="startIrrigation()">
                💧 Water Now
              </button>
            </div>
          </div>

          <!-- Smart Risk Assessment -->
          <div class="card">
            <h3 data-translate="smart_risk_assessment">
              Smart Risk Assessment
            </h3>
            <div class="spaced">
              <div>
                <div id="riskLevel" data-translate="risk">Risk: —</div>
                <div class="small muted" data-translate="assess_risk_text">
                  Press "Assess Risk" to evaluate live sensor conditions.
                </div>
              </div>
              <button
                id="assess-risk-btn"
                class="btn blue"
                onclick="assessRisk()"
              >
                <span data-translate="assess_risk_btn">Assess Risk</span>
              </button>
            </div>
          </div>

          <!-- AI Action Plan -->
          <div class="card gemini-widget">
            <h3 data-translate="ai_action_plan">AI Action Plan</h3>
            <div class="badge" data-translate="json_backed">JSON backed</div>
            <div id="gemini-output" class="output">
              Click "Generate Plan" to get AI-powered farming recommendations
              based on current sensor data.
            </div>
            <button class="btn orange" onclick="generateAIPlan()">
              🤖 Generate Plan
            </button>
          </div>

          <!-- Image Disease/Pest Analysis -->
          <div class="card gemini-widget">
            <h3 data-translate="image_disease_analysis">
              Image Disease/Pest Analysis
            </h3>
            <div class="badge" data-translate="vision">Vision AI</div>
            <div class="small muted" data-translate="attach_image_text">
              Upload a leaf/soil image using the Image Upload section below,
              then click "Analyze Image".
            </div>
            <div id="disease-output" class="output">
              Upload an image and click "Analyze Image" to detect diseases,
              pests, and crop health conditions.
            </div>
            <button class="btn purple" onclick="analyzeImage()">
              📸 Analyze Image
            </button>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div style="display: flex; flex-direction: column; gap: 20px">
          <!-- Active Alerts -->
          <div class="card">
            <h3 data-translate="active_alerts">Active Alerts</h3>
            <div class="alerts-container">
              <div class="alert alert-critical">
                <div class="spaced">
                  <div>
                    <h4 data-translate="critical_frost_warning">
                      CRITICAL Frost Warning
                    </h4>
                    <div class="small" data-translate="frost_warning_text">
                      A low of <b>-2°C</b> is forecast in 48 hours.
                      Consider protective measures.
                    </div>
                  </div>
                </div>
              </div>
              <div class="alert alert-info">
                <div class="spaced">
                  <div>
                    <h4 data-translate="info_irrigation">
                      INFO Irrigation Schedule
                    </h4>
                    <div
                      class="small"
                      data-translate="irrigation_schedule_text"
                    >
                      Next scheduled watering in 4 hours based on soil moisture
                      levels.
                    </div>
                  </div>
                  <div class="small muted">6 hours ago</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 5-Day Weather Forecast -->
          <div class="card">
            <h3 data-translate="weather_forecast">5-Day Weather Forecast</h3>
            <div class="forecast-container">
              <div class="forecast-day">
                <h4 data-translate="tomorrow">Tomorrow</h4>
                <div>26°C / 15°C</div>
                <div class="small" data-translate="partly_cloudy">
                  Partly Cloudy
                </div>
              </div>
              <div class="forecast-day">
                <h4 data-translate="saturday">Saturday</h4>
                <div>24°C / 13°C</div>
                <div class="small" data-translate="showers">Showers</div>
              </div>
              <div class="forecast-day">
                <h4 data-translate="sunday">Sunday</h4>
                <div>22°C / 10°C</div>
                <div class="small" data-translate="sunny">Sunny</div>
              </div>
              <div class="forecast-day">
                <h4 data-translate="monday">Monday</h4>
                <div>20°C / 8°C</div>
                <div class="small" data-translate="cloudy">Cloudy</div>
              </div>
              <div class="forecast-day">
                <h4 data-translate="tuesday">Tuesday</h4>
                <div>23°C / 11°C</div>
                <div class="small" data-translate="overcast">Overcast</div>
              </div>
            </div>
          </div>

          <!-- Image Upload -->
          <div class="card image-upload">
            <h4>📸 Image Upload for Analysis</h4>
            <label for="gemini-image">Upload Crop/Soil Image:</label>
            <input
              type="file"
              id="gemini-image"
              accept="image/*"
              onchange="previewImage(event)"
            />
            <div id="gemini-image-row">
              <img id="gemini-image-preview" alt="Preview" />
              <button
                class="btn"
                onclick="clearImage()"
                id="clear-btn"
                style="display: none"
              >
                Clear
              </button>
            </div>
            <div class="small muted" style="margin-top: 8px">
              Supported: JPG, PNG, WebP. Max 5MB. For best results, use clear,
              well-lit images of leaves or soil.
            </div>
          </div>

          <!-- Chat Section -->
          <div class="card chat">
            <h4 data-translate="chat_agriculture">Chat about Agriculture</h4>
            <div class="chat-window" id="chat-window"></div>
            <div class="chat-input-row">
              <input
                type="text"
                id="chat-input"
                placeholder="Ask about crops, weather, or farming..."
                onkeydown="handleChatKeydown(event)"
              />
              <button class="btn primary" onclick="sendChatMessage()">
                Send
              </button>
            </div>
          </div>

          <!-- Blog Section -->
          <div class="card">
            <h4 data-translate="blog_agriculture">Blog about Agriculture</h4>
            <div class="list" id="blog-list">
              <div class="list-item">
                <div class="title">Soil Health Management Tips</div>
                <div class="small muted">
                  Best practices for maintaining optimal soil conditions...
                </div>
              </div>
              <div class="list-item">
                <div class="title">Irrigation Efficiency Guide</div>
                <div class="small muted">
                  How to maximize water usage in your farming operations...
                </div>
              </div>
            </div>
          </div>

          <!-- Q&A Section -->
          <div class="card">
            <h4 data-translate="qa_agriculture">Q&A about Agriculture</h4>
            <div class="list" id="qa-list">
              <div class="list-item">
                <div class="title">Q: Best time to plant wheat?</div>
                <div class="small">
                  A: November-December is ideal in most regions...
                </div>
              </div>
              <div class="list-item">
                <div class="title">Q: How to prevent pest attacks?</div>
                <div class="small">
                  A: Regular monitoring and integrated pest management...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Translation data - FIXED: Escaped quotes properly
      const translations = {
        en: {
          title: "AgroSmart AI Dashboard (Fixed)",
          logo: "AgroSmart AI",
          farm: "Farm:",
          field_a_wheat: "Field A — Wheat",
          field_b_maize: "Field B — Maize",
          last_updated: "Last Updated:",
          logout: "Logout",
          soil_moisture: "Soil Moisture",
          optimal: "Optimal",
          soil_temperature: "Soil Temperature",
          atmosphere: "Atmosphere",
          temp_humidity: "Temp / Humidity",
          water_level: "Water Level",
          distance_from_sensor: "Distance from Sensor",
          wind: "Wind",
          from_nw: "from NW",
          irrigation_control: "Irrigation Control",
          last_watered: "Last Watered: Today at 6:00 AM",
          smart_risk_assessment: "Smart Risk Assessment",
          risk: "Risk: —",
          assess_risk_text:
            'Press "Assess Risk" to evaluate live sensor conditions.',
          assess_risk_btn: "Assess Risk",
          ai_action_plan: "AI Action Plan",
          json_backed: "JSON backed",
          image_disease_analysis: "Image Disease/Pest Analysis",
          vision: "Vision AI",
          attach_image_text:
            'Upload a leaf/soil image using the Image Upload section below, then click "Analyze Image".',
          active_alerts: "Active Alerts",
          critical_frost_warning: "CRITICAL Frost Warning",
          frost_warning_text:
            "A low of **-2°C** is forecast in 48 hours. Consider protective measures.",
          info_irrigation: "INFO Irrigation Schedule",
          irrigation_schedule_text:
            "Next scheduled watering in 4 hours based on soil moisture levels.",
          weather_forecast: "5-Day Weather Forecast",
          tomorrow: "Tomorrow",
          saturday: "Saturday",
          sunday: "Sunday",
          monday: "Monday",
          tuesday: "Tuesday",
          partly_cloudy: "Partly Cloudy",
          showers: "Showers",
          sunny: "Sunny",
          cloudy: "Cloudy",
          overcast: "Overcast",
          chat_agriculture: "Chat about Agriculture",
          blog_agriculture: "Blog about Agriculture",
          qa_agriculture: "Q&A about Agriculture",
          language: "Language:",
        },
        hi: {
          title: "एग्रोस्मार्ट एआई डैशबोर्ड",
          logo: "एग्रोस्मार्ट एआई",
          farm: "फार्म:",
          field_a_wheat: "खेत A — गेहूं",
          field_b_maize: "खेत B — मक्का",
          last_updated: "अंतिम बार अपडेट किया गया:",
          logout: "लॉगआउट",
          soil_moisture: "मिट्टी की नमी",
          optimal: "अनुकूल",
          soil_temperature: "मिट्टी का तापमान",
          atmosphere: "वातावरण",
          temp_humidity: "तापमान / आर्द्रता",
          water_level: "जल स्तर",
          distance_from_sensor: "सेंसर से दूरी",
          wind: "हवा",
          from_nw: "उत्तर-पश्चिम से",
          irrigation_control: "सिंचाई नियंत्रण",
          last_watered: "अंतिम सिंचाई: आज सुबह 6:00 बजे",
          smart_risk_assessment: "स्मार्ट जोखिम मूल्यांकन",
          risk: "जोखिम: —",
          assess_risk_text:
            'लाइव सेंसर स्थितियों का मूल्यांकन करने के लिए "जोखिम मूल्यांकन" दबाएं।',
          assess_risk_btn: "जोखिम मूल्यांकन",
          ai_action_plan: "एआई कार्य योजना",
          json_backed: "JSON समर्थित",
          image_disease_analysis: "चित्र रोग/कीट विश्लेषण",
          vision: "विजन एआई",
          attach_image_text:
            'नीचे दिए गए इमेज अपलोड सेक्शन का उपयोग करके पत्ती/मिट्टी की छवि अपलोड करें, फिर "इमेज एनालाइज़ करें" पर क्लिक करें।',
          active_alerts: "सक्रिय अलर्ट",
          critical_frost_warning: "गंभीर पाला चेतावनी",
          frost_warning_text:
            "48 घंटों में **-2°C** तक तापमान गिरने का अनुमान है। सुरक्षात्मक उपाय करें।",
          info_irrigation: "सूचना सिंचाई कार्यक्रम",
          irrigation_schedule_text:
            "मिट्टी की नमी के स्तर के आधार पर 4 घंटे में अगली निर्धारित सिंचाई।",
          weather_forecast: "5-दिवसीय मौसम पूर्वानुमान",
          tomorrow: "कल",
          saturday: "शनिवार",
          sunday: "रविवार",
          monday: "सोमवार",
          tuesday: "मंगलवार",
          partly_cloudy: "आंशिक बादल",
          showers: "बौछारें",
          sunny: "धूप",
          cloudy: "बादल",
          overcast: "घने बादल",
          chat_agriculture: "कृषि के बारे में चैट",
          blog_agriculture: "कृषि के बारे में ब्लॉग",
          qa_agriculture: "कृषि के बारे में प्रश्नोत्तर",
          language: "भाषा:",
        },
        gu: {
          title: "એગ્રોસ્માર્ટ AI ડેશબોર્ડ",
          logo: "એગ્રોસ્માર્ટ AI",
          farm: "ખેતર:",
          field_a_wheat: "ખેતર A — ઘઉં",
          field_b_maize: "ખેતર B — મકાઈ",
          last_updated: "છેલ્લે અપડેટ થયું:",
          logout: "લૉગઆઉટ",
          soil_moisture: "માટીની ભેજ",
          optimal: "યોગ્ય",
          soil_temperature: "માટીનું તાપમાન",
          atmosphere: "વાતાવરણ",
          temp_humidity: "તાપમાન / ભેજ",
          water_level: "પાણીનું સ્તર",
          distance_from_sensor: "સેન્સરથી અંતર",
          wind: "પવન",
          from_nw: "ઉત્તર-પશ્ચિમથી",
          irrigation_control: "સિંચાઈ નિયંત્રણ",
          last_watered: "છેલ્લે પાણી આપ્યું: આજે સવારે 6:00 વાગ્યે",
          smart_risk_assessment: "સ્માર્ટ જોખમ મૂલ્યાંકન",
          risk: "જોખમ: —",
          assess_risk_text:
            'લાઈવ સેન્સર પરિસ્થિતિઓનું મૂલ્યાંકન કરવા માટે "જોખમ મૂલ્યાંકન" દબાવો।',
          assess_risk_btn: "જોખમ મૂલ્યાંકન",
          ai_action_plan: "AI કાર્ય યોજના",
          json_backed: "JSON આધારિત",
          image_disease_analysis: "ચિત્ર રોગ/જીવાત વિશ્લેષણ",
          vision: "વિઝન AI",
          attach_image_text:
            'નીચે આપેલા ઇમેજ અપલોડ સેક્શનનો ઉપયોગ કરીને પાંદડા/માટીની છબી અપલોડ કરો, પછી "ઇમેજ એનાલાઇઝ કરો" પર ક્લિક કરો।',
          active_alerts: "સક્રિય ચેતવણીઓ",
          critical_frost_warning: "ગંભીર હિમ ચેતવણી",
          frost_warning_text:
            "48 કલાકમાં -2°C જેટલું તાપમાન જવાની આગાહી છે। સુરક્ષા ઉપાયો કરો।",
          info_irrigation: "માહિતી સિંચાઈ કાર્યક્રમ",
          irrigation_schedule_text:
            "માટીની ભેજના સ્તરના આધારે 4 કલાકમાં આગલી નિર્ધારિત સિંચાઈ.",
          weather_forecast: "5-દિવસીય હવામાન આગાહી",
          tomorrow: "કાલે",
          saturday: "શનિવાર",
          sunday: "રવિવાર",
          monday: "સોમવાર",
          tuesday: "મંગળવાર",
          partly_cloudy: "આંશિક વાદળછાયું",
          showers: "ફુવારો",
          sunny: "સની",
          cloudy: "વાદળછાયું",
          overcast: "ઘાટા વાદળો",
          chat_agriculture: "ખેતી વિશે ચેટ",
          blog_agriculture: "ખેતી વિશે બ્લૉગ",
          qa_agriculture: "ખેતી વિશે પ્રશ્નોત્તર",
          language: "ભાષા:",
        },
        mr: {
          title: "एग्रोस्मार्ट AI डॅशबोर्ड",
          logo: "एग्रोस्मार्ट AI",
          farm: "शेत:",
          field_a_wheat: "शेत A — गहू",
          field_b_maize: "शेत B — मका",
          last_updated: "शेवटचे अपडेट:",
          logout: "लॉगआउट",
          soil_moisture: "मातीची ओलावा",
          optimal: "योग्य",
          soil_temperature: "मातीचे तापमान",
          atmosphere: "वातावरण",
          temp_humidity: "तापमान / आर्द्रता",
          water_level: "पाण्याची पातळी",
          distance_from_sensor: "सेन्सरपासून अंतर",
          wind: "वारा",
          from_nw: "वायव्येकडून",
          irrigation_control: "सिंचन नियंत्रण",
          last_watered: "शेवटचे सिंचन: आज सकाळी 6:00 वाजता",
          smart_risk_assessment: "स्मार्ट जोखीम मूल्यांकन",
          risk: "जोखीम: —",
          assess_risk_text:
            'लाइव्ह सेन्सर परिस्थितींचे मूल्यांकन करण्यासाठी "जोखीम मूल्यांकन" दाबा.',
          assess_risk_btn: "जोखीम मूल्यांकन",
          ai_action_plan: "AI कृती योजना",
          json_backed: "JSON आधारित",
          image_disease_analysis: "चित्र रोग/किडी विश्लेषण",
          vision: "व्हिजन AI",
          attach_image_text:
            'खालील इमेज अपलोड सेक्शन वापरून पान/माती प्रतिमा अपलोड करा, नंतर "इमेज अॅनालायझ करा" वर क्लिक करा.',
          active_alerts: "सक्रिय अलर्ट",
          critical_frost_warning: "गंभीर तुषार चेतावणी",
          frost_warning_text:
            "48 तासांत -2°C पर्यंत तापमान जाण्याचा अंदाज आहे. संरक्षणात्मक उपाययोजना करा.",
          info_irrigation: "माहिती सिंचन वेळापत्रक",
          irrigation_schedule_text:
            "मातीच्या ओलावा पातळीच्या आधारावर 4 तासांत पुढील निर्धारित सिंचन.",
          weather_forecast: "5-दिवसीय हवामान अंदाज",
          tomorrow: "उद्या",
          saturday: "शनिवार",
          sunday: "रविवार",
          monday: "सोमवार",
          tuesday: "मंगळवार",
          partly_cloudy: "अर्धवट ढगाळ",
          showers: "पाऊस",
          sunny: "सनी",
          cloudy: "ढगाळ",
          overcast: "पूर्ण ढगाळ",
          chat_agriculture: "शेतीबद्दल चॅट",
          blog_agriculture: "शेतीबद्दल ब्लॉग",
          qa_agriculture: "शेतीबद्दल प्रश्न-उत्तर",
          language: "भाषा:",
        },
      };

      let currentLanguage = "en";

      // Enhanced Disease/Pest Analysis Database - MAJOR IMPROVEMENT
      const analysisDatabase = [
        {
          condition: "healthy",
          title: "🌱 Healthy Crop Detected",
          confidence: 92,
          severity: "healthy",
          description:
            "Crop appears to be in excellent health with no visible signs of disease or pest damage.",
          details:
            "Strong leaf color and structure observed. No discoloration, spots, or pest activity detected.",
          recommendations: [
            "Continue current care routine",
            "Monitor regularly for any changes",
            "Maintain optimal watering schedule",
            "Consider preventive treatments during high-risk seasons",
          ],
        },
        {
          condition: "leaf_spot",
          title: "🍂 Leaf Spot Disease Detected",
          confidence: 87,
          severity: "warning",
          description:
            "Fungal leaf spot disease identified. Circular brown/black spots visible on foliage.",
          details:
            "Classic symptoms of fungal infection with distinct lesions. Requires immediate treatment.",
          recommendations: [
            "Apply copper-based fungicide spray",
            "Remove affected leaves immediately",
            "Improve air circulation around plants",
            "Avoid overhead watering",
            "Monitor closely for spread",
          ],
        },
        {
          condition: "aphid_infestation",
          title: "🐛 Aphid Infestation Detected",
          confidence: 94,
          severity: "critical",
          description:
            "Significant aphid colony detected on plant tissue. Immediate intervention required.",
          details:
            "Multiple aphids visible, causing leaf curling and potential virus transmission risk.",
          recommendations: [
            "Apply neem oil or insecticidal soap",
            "Introduce beneficial insects (ladybugs)",
            "Spray affected areas with water",
            "Monitor daily for population changes",
            "Check neighboring plants for spread",
          ],
        },
        {
          condition: "nutrient_deficiency",
          title: "🌾 Nutrient Deficiency Signs",
          confidence: 79,
          severity: "warning",
          description:
            "Yellowing leaves suggest possible nitrogen or iron deficiency.",
          details:
            "Chlorosis pattern indicates nutritional stress. Soil testing recommended.",
          recommendations: [
            "Test soil pH and nutrient levels",
            "Apply balanced fertilizer",
            "Consider iron chelate if pH is high",
            "Improve soil drainage if necessary",
            "Monitor plant response to treatment",
          ],
        },
        {
          condition: "early_blight",
          title: "🦠 Early Blight Symptoms",
          confidence: 85,
          severity: "critical",
          description:
            "Early stage blight disease detected with characteristic dark lesions.",
          details:
            "Fungal pathogen causing concentric ring patterns on leaves. High spread risk.",
          recommendations: [
            "Remove all affected plant material",
            "Apply preventive fungicide treatment",
            "Increase plant spacing for air flow",
            "Avoid working with plants when wet",
            "Implement crop rotation next season",
          ],
        },
        {
          condition: "pest_damage",
          title: "🐞 General Pest Damage",
          confidence: 81,
          severity: "warning",
          description:
            "Chewing damage from insects detected on leaves and stems.",
          details:
            "Irregular holes and feeding patterns suggest caterpillar or beetle activity.",
          recommendations: [
            "Inspect plants for pest presence",
            "Apply appropriate insecticide treatment",
            "Use row covers if infestation is severe",
            "Encourage beneficial predator insects",
            "Monitor trap catches weekly",
          ],
        },
        {
          condition: "healthy_soil",
          title: "🏔️ Healthy Soil Condition",
          confidence: 88,
          severity: "healthy",
          description:
            "Soil structure and color indicate good health and fertility.",
          details:
            "Rich, dark soil with good aggregate structure. No visible compaction or drainage issues.",
          recommendations: [
            "Maintain current soil management",
            "Continue organic matter additions",
            "Test soil annually for nutrient status",
            "Practice crop rotation",
            "Monitor moisture levels regularly",
          ],
        },
        {
          condition: "powdery_mildew",
          title: "🤍 Powdery Mildew Detected",
          confidence: 90,
          severity: "critical",
          description:
            "White, powdery fungal growth detected on leaf surfaces.",
          details:
            "Classic powdery mildew symptoms with spore masses visible. High humidity conditions favorable.",
          recommendations: [
            "Apply sulfur-based fungicide",
            "Improve air circulation immediately",
            "Remove heavily infected leaves",
            "Reduce humidity around plants",
            "Treat early morning or evening",
          ],
        },
      ];

      // Language translation functionality
      function translatePage(language) {
        currentLanguage = language;
        const elements = document.querySelectorAll("[data-translate]");

        elements.forEach((element) => {
          const key = element.getAttribute("data-translate");
          if (translations[language] && translations[language][key]) {
            if (element.tagName === "INPUT" && element.type === "text") {
              element.placeholder = translations[language][key];
            } else if (element.tagName === "TITLE") {
              element.textContent = translations[language][key];
            } else {
              element.textContent = translations[language][key];
            }
          }
        });

        // Update HTML lang attribute
        document.getElementById("html-root").setAttribute("lang", language);

        // Store language preference
        localStorage.setItem("selectedLanguage", language);
      }

      // Language selector event handler
      document
        .getElementById("language-selector")
        .addEventListener("change", function () {
          translatePage(this.value);
        });

      // Load saved language preference on page load
      document.addEventListener("DOMContentLoaded", function () {
        const savedLanguage = localStorage.getItem("selectedLanguage") || "en";
        document.getElementById("language-selector").value = savedLanguage;
        translatePage(savedLanguage);
        updateLastUpdated(); // Initialize timestamp
      });

      // Existing JavaScript functionality (unchanged)
      let sensorData = {
        soilMoisture: 45,
        soilTemperature: 22,
        atmosphereTemp: null,
        atmosphereHumidity: null,
        waterLevel: null,
        windSpeed: 12,
        windDirection: "NW",
      };

      let chatHistory = [];

      // FIXED: Corrected the updateLastUpdated function logic
      function updateLastUpdated() {
        const now = new Date();
        const lastUpdatedEl = document.getElementById("last-updated");
        const timestamp = `${
          translations[currentLanguage]["last_updated"]
        } ${now.toLocaleString()}`;
        if (lastUpdatedEl) {
          lastUpdatedEl.textContent = timestamp;
        }
        return timestamp;
      }

      function startIrrigation() {
        const statusEl = document.getElementById("irrigationStatus");
        statusEl.textContent = translations[currentLanguage]["last_watered"];
        alert("💧 Irrigation started!");
        updateLastUpdated();
      }

      function assessRisk() {
        const riskBtn = document.getElementById("assess-risk-btn");
        const originalText = riskBtn.innerHTML;
        riskBtn.textContent = "Assessing...";
        riskBtn.disabled = true;

        setTimeout(() => {
          const risk =
            Math.random() > 0.7
              ? "High"
              : Math.random() > 0.4
              ? "Medium"
              : "Low";
          document.getElementById("riskLevel").textContent = `${translations[
            currentLanguage
          ]["risk"].replace("—", risk)}`;
          riskBtn.innerHTML = originalText;
          riskBtn.disabled = false;
          updateLastUpdated();
        }, 2000);
      }

      // Enhanced Mock Gemini API integration - MAJOR IMPROVEMENT
      const GEMINI_API_KEY = "your-api-key-here";
      const GEMINI_MODEL = "gemini-1.5-flash";

      async function callGemini(prompt, imageBase64 = null) {
        // Simulate realistic API response time
        const responseTime = Math.random() * 2000 + 1500; // 1.5-3.5 seconds
        await new Promise((resolve) => setTimeout(resolve, responseTime));

        // Enhanced image analysis - FIXED: Much more realistic responses
        if (imageBase64) {
          const randomAnalysis =
            analysisDatabase[
              Math.floor(Math.random() * analysisDatabase.length)
            ];
          return formatAnalysisResult(randomAnalysis);
        }

        // AI Action Plan responses
        if (
          prompt.includes("farming") ||
          prompt.includes("agriculture") ||
          prompt.includes("sensor")
        ) {
          const responses = [
            `📊 Based on current sensor data:\n• Soil moisture: ${sensorData.soilMoisture}% (Optimal range)\n• Temperature: ${sensorData.soilTemperature}°C (Good for growth)\n• Wind: ${sensorData.windSpeed} km/h from ${sensorData.windDirection}\n\n🎯 Recommendations:\n• Monitor for frost protection in 48 hours\n• Continue current irrigation schedule\n• Consider applying preventive fungicide\n• Check drainage systems before next rainfall`,

            `🌱 Smart Farming Analysis:\n• Current conditions favor plant growth\n• Soil moisture levels are ideal\n• Temperature range supports photosynthesis\n\n⚠️ Action Items:\n• Prepare frost protection measures\n• Schedule next fertilizer application\n• Monitor pest activity levels\n• Calibrate irrigation sensors weekly`,

            `📈 Agricultural Insights:\n• Growing conditions are within optimal range\n• Weather forecast shows potential challenges\n• Soil health indicators are positive\n\n✅ Next Steps:\n• Implement integrated pest management\n• Adjust watering schedule for forecast\n• Review crop nutrition program\n• Plan for seasonal transitions`,
          ];

          return responses[Math.floor(Math.random() * responses.length)];
        }

        return "AI analysis completed successfully. Please provide more specific information for detailed recommendations.";
      }

      // NEW: Format analysis results with confidence and styling
      function formatAnalysisResult(analysis) {
        const confidenceClass =
          analysis.confidence >= 85
            ? "high"
            : analysis.confidence >= 70
            ? "medium"
            : "low";
        const severityIcon =
          analysis.severity === "healthy"
            ? "✅"
            : analysis.severity === "warning"
            ? "⚠️"
            : "🚨";

        let result = `${severityIcon} ${analysis.title}\n\n`;
        result += `📋 Analysis: ${analysis.description}\n\n`;
        result += `🔍 Details: ${analysis.details}\n\n`;
        result += `📊 Confidence: ${analysis.confidence}%\n\n`;
        result += `💡 Recommendations:\n`;

        analysis.recommendations.forEach((rec, index) => {
          result += `${index + 1}. ${rec}\n`;
        });

        result += `\n⏰ Analysis completed at ${new Date().toLocaleTimeString()}`;

        return result;
      }

      async function generateAIPlan() {
        const output = document.getElementById("gemini-output");
        output.textContent =
          "🤖 Generating AI-powered farming plan...\n\nAnalyzing sensor data and environmental conditions...";

        try {
          const prompt = `Based on these sensor readings: Soil moisture: ${sensorData.soilMoisture}%, Soil temperature: ${sensorData.soilTemperature}°C, Wind: ${sensorData.windSpeed} km/h from ${sensorData.windDirection}. Provide comprehensive farming recommendations.`;

          const response = await callGemini(prompt);
          output.textContent = response;
        } catch (error) {
          output.textContent = `❌ Error generating plan: ${error.message}\n\nPlease check your connection and try again.`;
        }
      }

      let currentImageBase64 = null;
      let currentImageFile = null;

      function previewImage(event) {
        const file = event.target.files[0];
        const preview = document.getElementById("gemini-image-preview");
        const clearBtn = document.getElementById("clear-btn");

        if (file) {
          // Enhanced file validation
          const maxSize = 5 * 1024 * 1024; // 5MB
          const allowedTypes = [
            "image/jpeg",
            "image/jpg",
            "image/png",
            "image/webp",
          ];

          if (file.size > maxSize) {
            alert("❌ File too large! Please select an image under 5MB.");
            event.target.value = "";
            return;
          }

          if (!allowedTypes.includes(file.type)) {
            alert(
              "❌ Invalid file type! Please select a JPG, PNG, or WebP image."
            );
            event.target.value = "";
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            currentImageBase64 = e.target.result.split(",")[1];
            currentImageFile = file;
            preview.src = e.target.result;
            preview.style.display = "block";
            clearBtn.style.display = "inline-block";
          };
          reader.readAsDataURL(file);
        }
      }

      function clearImage() {
        document.getElementById("gemini-image").value = "";
        document.getElementById("gemini-image-preview").style.display = "none";
        document.getElementById("clear-btn").style.display = "none";
        currentImageBase64 = null;
        currentImageFile = null;
      }

      // ENHANCED: Much improved image analysis function
      async function analyzeImage() {
        const output = document.getElementById("disease-output");

        if (!currentImageBase64) {
          output.textContent =
            "⚠️ Please upload an image first using the Image Upload section below.\n\nSupported formats: JPG, PNG, WebP (max 5MB)";
          return;
        }

        // Show detailed analysis progress
        const progressSteps = [
          "🔄 Initializing AI vision analysis...",
          "📸 Processing uploaded image...",
          "🔍 Detecting crop features and anomalies...",
          "🧠 Running disease/pest identification algorithms...",
          "📊 Calculating confidence scores...",
          "✅ Generating analysis report...",
        ];

        let stepIndex = 0;
        const progressInterval = setInterval(() => {
          if (stepIndex < progressSteps.length) {
            output.textContent =
              progressSteps[stepIndex] +
              `\n\nImage: ${currentImageFile.name} (${(
                currentImageFile.size / 1024
              ).toFixed(1)} KB)`;
            stepIndex++;
          }
        }, 600);

        try {
          const response = await callGemini(
            "Analyze this crop image for diseases, pests, and overall plant health",
            currentImageBase64
          );

          clearInterval(progressInterval);
          output.textContent = response;

          // Update last updated timestamp
          updateLastUpdated();
        } catch (error) {
          clearInterval(progressInterval);
          output.textContent = `❌ Analysis failed: ${error.message}\n\nTroubleshooting:\n• Check your internet connection\n• Try uploading a clearer image\n• Ensure image shows crop/soil clearly\n• Try again in a few moments`;
        }
      }

      function addChatMessage(role, message) {
        chatHistory.push({ role, message });
        const chatWindow = document.getElementById("chat-window");
        const msgDiv = document.createElement("div");
        msgDiv.className = "chat-msg";
        msgDiv.innerHTML = `<span class="role">${role}:</span>${message}`;
        chatWindow.appendChild(msgDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      async function sendChatMessage() {
        const input = document.getElementById("chat-input");
        const message = input.value.trim();

        if (!message) return;

        addChatMessage("You", message);
        input.value = "";

        try {
          const response = await callGemini(`Agriculture chat: ${message}`);
          addChatMessage("AI", response);
        } catch (error) {
          addChatMessage("System", "❌ Error: " + error.message);
        }
      }

      function handleChatKeydown(event) {
        if (event.key === "Enter") {
          sendChatMessage();
        }
      }

      // Initialize the dashboard
      setInterval(() => {
        updateLastUpdated();
      }, 30000);
    </script>
  </body>
</html>

